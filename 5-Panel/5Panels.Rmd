---
title: "5: Beginning with Panels"
subtitle: "Time Series and Panels"
author: "<large>J. Seawright</large>"
institute: "<small>Northwestern Political Science</small>" 
date: "April 27, 2023"
output: 
  xaringan::moon_reader:
    css: xaringan-themer.css
     

---
class: center, middle

```{r, load_refs, include=FALSE, cache=FALSE}
# Initializes the bibliography
library(RefManageR)

library(ggplot2)
library(dplyr)
library(nlme)

BibOptions(check.entries = FALSE,
           bib.style = "authoryear", # Bibliography style
           max.names = 3, # Max author names displayed in bibliography
           sorting = "nyt", #Name, year, title sorting
           cite.style = "authoryear", # citation style
           style = "markdown",
           hyperlink = FALSE,
           dashed = FALSE)
#myBib <- ReadBib("assets/myBib.bib", check = FALSE)
# Note: don't forget to clear the knitr cache to account for changes in the
# bibliography.
library(DT)

usrightplotsexpanded <- read.csv("C:/Users/jnsno/OneDrive - Northwestern University/Seawright Teaching/TSCS Teaching/usrightplotsexpanded.csv")
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono"),
  text_font_size = "1.6rem"
)
```


---
### Types of Panel Data Structures

1.  Pooled time series

2.  Linked, repeated cross-sections


---
### Pooled Models

$$Y_{i,t} = \alpha + \beta \mathbf{X}_{i,t} + \epsilon_{i,t}$$

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}

rightplotslmpooled1 <- lm(rightwingplots ~ I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24,
                          data=usrightplotsexpanded)

summary(rightplotslmpooled1)

```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}

rightplotslmpooled2 <- lm(rightwingplots ~ I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            I(blackalone/totalpop) +
                            I((blackalone/totalpop)^2) +
                            unemployment24,
                          data=usrightplotsexpanded)

summary(rightplotslmpooled2)

```



---
### Heterogeneity

$$Y_{i,t} = \alpha_{i} + \beta_{i} \mathbf{X}_{i,t} + \epsilon_{i,t}$$


---
### Fixed Effects

$$Y_{i,t} = \alpha_{i} + \beta \mathbf{X}_{i,t} + \epsilon_{i,t}$$


---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}

rightplotslmfe1 <- lm(rightwingplots ~ state + I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24,
                          data=usrightplotsexpanded)

summary(rightplotslmfe1)

```


---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
library(plm)

rightplotslmfe2 <- plm(rightwingplots ~ state + I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24,
                          effect = "individual",
                          model = "within",
                          data=usrightplotsexpanded,
                          index=c("state","year"))

```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}

summary(rightplotslmfe2)

```


---
### Fixed Effects

-   No serial autocorrelation

-   No spatial autocorrelation

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
pbgtest(rightplotslmfe2, order=5)

```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
usplotspdata <- pdata.frame(usrightplotsexpanded, index=c("state", "year"))

rightplotslmlag <- plm(rightwingplots ~ state + I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) + 
                            lag(usplotspdata$rightwingplots) +
                            unemployment24,
                          effect = "individual",
                          model = "within",
                          data=usplotspdata)
```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}

summary(rightplotslmlag)
```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
pbgtest(rightplotslmlag, order=5)

```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
usplotspdata <- pdata.frame(usrightplotsexpanded, index=c("state", "year"))

rightplotslmlag2 <- plm(rightwingplots ~ state + I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) + 
                            lag(usplotspdata$rightwingplots) +
                            lag(usplotspdata$rightwingplots, k = 2L) +
                            unemployment24,
                          effect = "individual",
                          model = "within",
                          data=usplotspdata)
```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}

summary(rightplotslmlag2)
```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
pbgtest(rightplotslmlag2, order=5)

```

---
### Two-Way Fixed Effects

$$Y_{i,t} = \alpha_{i} + \lambda_{t} + \beta \mathbf{X}_{i,t} + \epsilon_{i,t}$$


---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
rightplotslmfe3 <- plm(rightwingplots ~ state + I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24,
                          effect = "twoways",
                          model = "within",
                          data=usrightplotsexpanded,
                          index=c("state","year"))
```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
summary(rightplotslmfe3)

```

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
pFtest(rightplotslmfe3, rightplotslmfe2)
```

---
### Poolability

$$Y_{i,t} = \alpha_{i} + \lambda_{t} + \beta_{i} \mathbf{X}_{i,t} + \epsilon_{i,t}$$


---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
rightplotspvcm <- pvcm(rightwingplots ~ I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24,
                          effect = "individual",
                          model = "within",
                          data=usrightplotsexpanded,
                          index=c("state","year"))

pooltest(rightplotslmfe2, rightplotspvcm)
```





---
### Other Issues

-   Contemporaneous correlations

-   Heteroskedasticity

-   Unit-specific dynamics



---
```{r, echo = FALSE}
# Build dataset with different distributions
vcmcoefs <- data.frame(
  type = c( rep("linear coefficients", length(rightplotspvcm$coefficients[,2])), rep("quadratic coefficents", length(rightplotspvcm$coefficients[,3])) ),
  value = c( rightplotspvcm$coefficients[,2],         
             rightplotspvcm$coefficients[,3])
)

# Represent it
p <- vcmcoefs %>%
  ggplot( aes(x=value, fill=type)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    labs(fill="")

p
```

---
$$Y_{i,t} = \alpha_{i} + \beta \mathbf{X}_{i,t} + \epsilon_{i,t}$$


---
$$Y_{i,t} = a + \beta \mathbf{X}_{i,t} + \epsilon_{i,t}$$

$$\epsilon_{i,t} = \alpha_{i} + \nu_{i,t}$$

---
```{r, echo = TRUE, out.width="100%", fig.retina = 1}
library(plm)

rightplotslmre <- plm(rightwingplots ~ I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24,
                          effect = "individual",
                          model = "random",
                          data=usrightplotsexpanded,
                          index=c("state","year"))

```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
summary(rightplotslmre)

```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
phtest(rightplotslmre, rightplotslmfe2)

```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
rightplotslme1 <- lme(rightwingplots ~ I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24, data=usrightplotsexpanded, 
                            random = ~1|state,
                      na.action = na.omit)

```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
summary(rightplotslme1)
```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
rightplotslme2 <- lme(rightwingplots ~ I(whitealone/totalpop) +
                            I((whitealone/totalpop)^2) +
                            unemployment24, data=usrightplotsexpanded, 
                            random = ~1 + unemployment24 |state,
                      na.action = na.omit)

```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
summary(rightplotslme2)
```

---
```{r, echo = TRUE, out.height="100%", fig.retina = 1}
anova(rightplotslme1, rightplotslme2)
```


---
![image](socpanels1.jpg)


---
![image](socpanels2.jpg)


---
![image](reefficient.jpg)


---
1.  RE is more efficient only if errors are homoskedastic and serially
    uncorrelated.

2.  Throwing away between variation can be an advantage because it
    eliminates some kinds of confounding.

3.  If the RE model is wrong, then it also may not be efficient.


---
1.  Unit heterogeneity

2.  "Sluggish" right-hand-side variables

3.  If the RE model is wrong, then it also may not be efficient.

4.  Time dynamics


---
![image](polscipanels.jpg)


---
![image](unitfeadded.jpg)


---
![image](fepicture.jpg)


---
![image](fepicture2.jpg)


---
![image](tscsconclusion.jpg)


---
![image](Hung1.jpg)


---
![image](Hung2.jpg)


---
![image](oilpanels.jpg)

